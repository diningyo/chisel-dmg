import chisel3._
import org.scalatest._
import chiseltest._

object Inst170DECR extends FlatSpec with ChiselScalatestTester with TestUtil {
  def apply(implicit dut: CpuTestTb) {
    // test code starts from $0150.
    dut.clock.step(0x50)

    // skip register initialization.
    dut.clock.step(0x0e)
    compareReg(0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x00, 0x0000, 0x015e, false, false, false, false) // fetch first test code

    // dec b                    ; b = $01 / z = 0 / n = 0 / h = 0 / c = 0
    compareReg(0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0000, 0x015f, false, false, false, false) // m1

    // dec c                    ; c = $01 / z = 0 / n = 0 / h = 0 / c = 0
    compareReg(0x02, 0x01, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0000, 0x0160, false, true,  false, false) // m1

    // dec d                    ; d = $01 / z = 0 / n = 0 / h = 0 / c = 0
    compareReg(0x02, 0x01, 0x01, 0x02, 0x02, 0x02, 0x02, 0x0000, 0x0161, false, true,  false, false) // m1

    // dec e                    ; e = $01 / z = 0 / n = 0 / h = 0 / c = 0
    compareReg(0x02, 0x01, 0x01, 0x01, 0x02, 0x02, 0x02, 0x0000, 0x0162, false, true,  false, false) // m1

    // dec h                    ; l = $01 / z = 0 / n = 0 / h = 0 / c = 0
    compareReg(0x02, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x0000, 0x0163, false, true,  false, false) // m1

    // dec l                    ; h = $01 / z = 0 / n = 0 / h = 0 / c = 0
    compareReg(0x02, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x0000, 0x0164, false, true,  false, false) // m1

    // dec a                    ; a = $01 / z = 0 / n = 0 / h = 0 / c = 0
    compareReg(0x02, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0000, 0x0165, false, true,  false, false) // m1

    // ;; check z flag
    // ld  a, $00               ; a = $00
    compareReg(0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0000, 0x0166, false, true,  false, false) // m1
    compareReg(0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0000, 0x0167, false, true,  false, false) // m2

    // dec a                    ; a = $ff / z = 1
    compareReg(0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0000, 0x0168, false, true,  false, false) // m2

    // ;; check h / c flag
    // ld  a, $00               ; a = $00
    compareReg(0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0000, 0x0169, true,  true,  false, false) // m1
    compareReg(0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0000, 0x016a, true,  true,  false, false) // m2

    // dec a                    ; a = $ff / h = 1 / c = 0
    compareReg(0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0000, 0x016b, true,  true,  false, false) // m2

    // ;; check h flag
    // ld  a, $0f
    compareReg(0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0000, 0x016c, false, true,  true,  false) // m1
    compareReg(0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0000, 0x016d, false, true,  true,  false) // m2

    // dec a                    ; a = $10 / z = 0 / h = 1 / c = 0
    compareReg(0x10, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0000, 0x016e, false, true,  true,  false) // m1
    compareReg(0x0f, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0000, 0x016f, false, true,  true,  false) // m1 - nop
  }
}
